import pandas as pd
import re
import os

# --- User-defined variables ---
file_path = r"D:\hkiu\hjk"          # Excel file location
sheet_name = "Sheet0"               # Sheet name
search_column = "G"                 # Column containing comma-separated numbers
check_column = "D"                  # Column where numbers are checked
output_file = r"D:\hkiu\updated_file.xlsx"  # Output location

# --- Read Excel file ---
if not os.path.isfile(file_path):
    raise FileNotFoundError(f"File not found at {file_path}")

df = pd.read_excel(file_path, sheet_name=sheet_name)

# --- Extract numbers from column G (comma-separated) ---
def extract_numbers(value):
    if pd.isnull(value):
        return []
    # split by comma and clean spaces
    return [v.strip() for v in str(value).split(',') if v.strip()]

all_numbers = set()
df['Extracted_Numbers'] = df[search_column].apply(extract_numbers)
for sublist in df['Extracted_Numbers']:
    all_numbers.update(sublist)

# --- For each number, search column D and update column G of the found rows ---
# We'll store updates in a dictionary (row index to values to append)
updates = {}

for number in all_numbers:
    # Find rows in column D that contain this number
    matches = df[df[check_column].astype(str).str.contains(rf'\b{re.escape(number)}\b', regex=True, na=False)]
    for idx in matches.index:
        if idx not in updates:
            updates[idx] = []
        updates[idx].append(number)

# --- Append the found numbers to column G of those rows ---
for idx, values in updates.items():
    existing_val = str(df.at[idx, search_column]) if not pd.isnull(df.at[idx, search_column]) else ""
    existing_numbers = extract_numbers(existing_val)
    # Add unique numbers
    combined = set(existing_numbers + values)
    df.at[idx, search_column] = ', '.join(sorted(combined, key=lambda x: float(re.sub(r'%', '', x))))

# --- Drop the helper column ---
df.drop(columns=['Extracted_Numbers'], inplace=True)

# --- Save the updated file ---
df.to_excel(output_file, index=False, sheet_name=sheet_name)

print(f"Completed. Updated file saved at: {output_file}")
